name: HTML CSS CI Pipeline

# Trigger the workflow on push to main branch
on:
  push:
    branches: [ main ]

jobs:
  pipeline-job:
  
    runs-on: self-hosted
    defaults:
      run:
        shell: wsl.exe bash --noprofile --norc -e -o pipefail {0}

    steps:
      # Stage 1: Checkout Code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Stage 2: Build
      - name: Build Stage
        run: |
          echo "Starting Build Process for HTML/CSS..."
          if [ -f index.html ]; then
            echo "Build Success: index.html found."
          else
            echo "Build Failed: index.html missing!"
            exit 1
          fi

      # Stage 3: Run Application (Localhost Port 8888)
      - name: Run Application
        run: |
          echo "Starting application on localhost:8888..."
          nohup python3 -m http.server 8888 > server.log 2>&1 &
          echo "Server launched in background."
          sleep 5

      # Stage 4: Test/Validate (Using curl)
      - name: Validate Application
        run: |
          echo "Testing connectivity..."
          curl -I http://localhost:8888
          echo "Validation Passed: Application is running on port 8888."
          
      # Clean up 
      - name: Cleanup
        if: always()
        run: |
          pkill -f "http.server" || echo "Server already stopped"